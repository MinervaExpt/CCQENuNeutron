#ifndef ZExp_H
#define ZExp_H

#include "TParameter.h"
#include <string>
#include "include/GeneralIncludes.h"
#include "TMath.h"


namespace Zexp{

  double gA = -1.2723;
  double Mpion = .1395702;
  double Q2max=1;
  int nak = 4;
  vector<double> ak;

  double z(double Q2,double tcut, double t0)
  {
    double q2 = -Q2;
    double t1 = pow( tcut-q2, 0.5 );
    double t2 = pow( tcut-t0, 0.5 );
    return (t1-t2)/(t1+t2);
  }

  double t0optimal(double tcut )
  {
    return tcut*(1-pow(1+Q2max/tcut,0.5));
  }
  void SetQ2Max( double Q2 ){ Q2max = Q2; };

  void SetPar( string exp = "BNL" )
  {
    if( exp == "BNL" ) ak=vector<double>({-1,2.24,0.6,-5.4,2.2});
    if( exp == "ANL" ) ak=vector<double>({-1,2.25,0.2,-4.9,2.7});
    if( exp == "FNAL" ) ak=vector<double>({-1,2.02,-1.2,-0.7,0.1});
    if( exp == "FINAL") ak=vector<double>({-0.757841755388,2.3,-0.6,-3.8,2.3});

  }

  double FA(double Q2)
  {
    double ret=0;
    double tcut = 9*Mpion*Mpion;
    //double tcut = 0.18;
    double t0 = t0optimal(tcut);
    //double t0 = -0.28;
    double zval = z(Q2,tcut, t0);
    cout<<Q2<<", "<<zval<<endl;
    for( int i = 0; i<=nak; i++ )
    {
      ret+=ak[i]*pow(zval,i);
    }
    return ret;
  }

  double MeyerFitError( double Q2 )
  {
    return 1.2723*TMath::Sqrt((2.676043265977421 + 7.887891266775364e-31*TMath::Power(Q2,8) - 6.391133649071777*TMath::Sqrt(0.1753196 + Q2) + TMath::Power(Q2,2)*(117.42843735460404 - 143.48830950595465*TMath::Sqrt(0.1753196 + Q2)) + TMath::Power(Q2,3)*(167.98419265781618 - 116.73181645952332*TMath::Sqrt(0.1753196 + Q2)) + Q2*(30.327134563028242 - 54.20251570430736*TMath::Sqrt(0.1753196 + Q2)) + TMath::Power(Q2,7)*(1.76807423578193e-28 + 1.2537224710184266e-30*TMath::Sqrt(0.1753196 + Q2)) + TMath::Power(Q2,6)*(6.7759103375720345e-15 + 1.3652805322741727e-28*TMath::Sqrt(0.1753196 + Q2)) + TMath::Power(Q2,4)*(42.14737767889076 + 2.803208321734435e-14*TMath::Sqrt(0.1753196 + Q2)) + TMath::Power(Q2,5)*(-9.910985606529808e-14 + 8.352940728214283e-14*TMath::Sqrt(0.1753196 + Q2)))/TMath::Power(0.6747737373238151 + TMath::Sqrt(0.1753196 + Q2),16));
  }

  double MeyerFitCV( double Q2 )
  {
    return (-0.4541096590398484 + 1.9539925233402755e-14*TMath::Power(Q2,4) - 5.126706276695963*TMath::Sqrt(0.1753196 + Q2) + Q2*(-1.4397535998531852 - 23.824184045093943*TMath::Sqrt(0.1753196 + Q2)) + TMath::Power(Q2,2)*(6.584433052853172 - 1.700329887875803e-13*TMath::Sqrt(0.1753196 + Q2)) + TMath::Power(Q2,3)*(1.7002232910386852e-13 - 8.348877145181177e-14*TMath::Sqrt(0.1753196 + Q2)))/TMath::Power(0.6747737373238151 + TMath::Sqrt(0.1753196 + Q2),8) ;
  }

  //double TejinFitErr( double Q2 )
  //{
  //  return 1.2723*TMath::Sqrt((53.00819125627959 + 4.33912531532207e-33*TMath::Power(Q2,6) - 126.59826510342349*TMath::Sqrt(0.1753196 + Q2) + Q2*(237.37569906146 - 205.86906143701242*TMath::Sqrt(0.1753196 + Q2)) + TMath::Power(Q2,2)*(78.502531756419 - 1.0447617825884385e-13*TMath::Sqrt(0.1753196 + Q2)) + TMath::Power(Q2,4)*(1.098188656772625e-15 - 2.94782380767427e-31*TMath::Sqrt(0.1753196 + Q2)) + TMath::Power(Q2,5)*(1.8127182296289596e-31 + 1.3023625122110204e-32*TMath::Sqrt(0.1753196 + Q2)) + TMath::Power(Q2,3)*(-2.8428695341990747e-15 + 2.7440179407946085e-15*TMath::Sqrt(0.1753196 + Q2)))/TMath::Power(0.9774045204427637 + TMath::Sqrt(0.1753196 + Q2),12)) ;
  //}

  //double TejinFitCV( double Q2 )
  //{
  //  return (-7.255957396427355 + 2.78132157077634e-15*TMath::Power(Q2,2) + 2.220446049250313e-16*TMath::Power(Q2,3) - 5.171872652829385*TMath::Sqrt(0.1753196 + Q2) + Q2*(-22.983789728197863 + 4.003359555674841e-15*TMath::Sqrt(0.1753196 + Q2)))/ TMath::Power(0.9774045204427637 + TMath::Sqrt(0.1753196 + Q2),6);
  //}


  double TejinFitErr( double Q2 )
  {
    return 1.2723*TMath::Sqrt((54.236022211500256 + 5.662642067371012e-33*TMath::Power(Q2,6) - 129.53066602273995*TMath::Sqrt(0.1753196 + Q2) + Q2*(245.30327719409394 - 216.4393018656609*TMath::Sqrt(0.1753196 + Q2)) + TMath::Power(Q2,2)*(88.58510940082552 - 1.1137764283943206e-13*TMath::Sqrt(0.1753196 + Q2)) + TMath::Power(Q2,4)*(1.3272534797056941e-15 - 3.341654812563205e-31*TMath::Sqrt(0.1753196 + Q2)) + TMath::Power(Q2,5)*(1.9410185460712498e-31 + 3.1602308330387306e-33*TMath::Sqrt(0.1753196 + Q2)) + TMath::Power(Q2,3)*(-3.1822701506344314e-15 + 1.8232873430986643e-15*TMath::Sqrt(0.1753196 + Q2)))/ TMath::Power(0.9774045204427637 + TMath::Sqrt(0.1753196 + Q2),12));
  }

  double TejinFitCV( double Q2 )
  {
    return (-8.838811786503348 - 1.5543122344752192e-15*TMath::Power(Q2,3) - 1.391577288172529*TMath::Sqrt(0.1753196 + Q2) + Q2*(-26.420986024084414 - 1.0266271847811751e-15*TMath::Sqrt(0.1753196 + Q2)) + TMath::Power(Q2,2)*(-1.7056826014318743e-15 + 4.440892098500626e-15*TMath::Sqrt(0.1753196 + Q2)))/TMath::Power(0.9774045204427637 + TMath::Sqrt(0.1753196 + Q2),6);
  }


















  double Zexp(double Q2, double *par)
  {
    double a1 = par[0];
    double a2 = par[1];
    double a3 = par[2];
    double a4 = par[3];

    return -0.7874015748031495*(-1.189731573670486 + 0.1806060300153102*a1 - 0.07290143984451301*a2 + 0.0017670719063017247*a3 - 0.0065355373121289825*a4 + 
             ((-41.64060507846701 + 26.321211050535858*a1 + 7.448449605442044*a2 + 4.061847516720561*a3 + 0.7712561940754856*a4)*TMath::Power(-0.6747729368514208 + TMath::Sqrt(0.17531851630709155 + Q2),8))/
                   TMath::Power(0.6747729368514208 + TMath::Sqrt(0.17531851630709155 + Q2),8) + ((142.76778884045834 - 91.67272360183722*a1 - 27.251827218658438*a2 - 15.212048628756207*a3 - 3.215735522544522*a4)*
                             TMath::Power(-0.6747729368514208 + TMath::Sqrt(0.17531851630709155 + Q2),7))/TMath::Power(0.6747729368514208 + TMath::Sqrt(0.17531851630709155 + Q2),7) + 
                        ((-166.56242031386805 + 109.28484420214343*a1 + 34.79379842176818*a2 + 20.247390066882243*a3 + 5.0850247763019425*a4)*TMath::Power(-0.6747729368514208 + TMath::Sqrt(0.17531851630709155 + Q2),6))/
                              TMath::Power(0.6747729368514208 + TMath::Sqrt(0.17531851630709155 + Q2),6) + ((66.62496812554723 - 45.11393768085737*a1 - 15.917519368707271*a2 - 10.098956026752896*a3 - 3.634009910520777*a4)*
                                        TMath::Power(-0.6747729368514208 + TMath::Sqrt(0.17531851630709155 + Q2),5))/TMath::Power(0.6747729368514208 + TMath::Sqrt(0.17531851630709155 + Q2),5) + 
                                   (a4*TMath::Power(-0.6747729368514208 + TMath::Sqrt(0.17531851630709155 + Q2),4))/TMath::Power(0.6747729368514208 + TMath::Sqrt(0.17531851630709155 + Q2),4) + 
                                        (a3*TMath::Power(-0.6747729368514208 + TMath::Sqrt(0.17531851630709155 + Q2),3))/TMath::Power(0.6747729368514208 + TMath::Sqrt(0.17531851630709155 + Q2),3) + 
                                             (a2*TMath::Power(-0.6747729368514208 + TMath::Sqrt(0.17531851630709155 + Q2),2))/TMath::Power(0.6747729368514208 + TMath::Sqrt(0.17531851630709155 + Q2),2) + 
                                                  (a1*(-0.6747729368514208 + TMath::Sqrt(0.17531851630709155 + Q2)))/(0.6747729368514208 + TMath::Sqrt(0.17531851630709155 + Q2)));


  }

  double TejinFitError( double Q2 )
  {

   return TMath::Sqrt((2.8442084191379684 + 2.1868461226625884e-31*TMath::Power(Q2,8) - 6.79277961127506*TMath::Sqrt(0.17531851630709155 + Q2) + TMath::Power(Q2,2)*(105.84297987476184 - 120.29833721374906*TMath::Sqrt(0.17531851630709155 + Q2)) + 
      TMath::Power(Q2,3)*(116.39218518248252 - 71.9254468390537*TMath::Sqrt(0.17531851630709155 + Q2)) + Q2*(31.098899806918435 - 54.90034668707639*TMath::Sqrt(0.17531851630709155 + Q2)) + 
      TMath::Power(Q2,6)*(-2.0502725706329765e-15 - 3.8123423203841734e-29*TMath::Sqrt(0.17531851630709155 + Q2)) + TMath::Power(Q2,7)*(4.018274682672532e-29 + 4.61165699676827e-30*TMath::Sqrt(0.17531851630709155 + Q2)) + 
      TMath::Power(Q2,5)*(-4.061824218124867e-14 + 2.524789944471972e-15*TMath::Sqrt(0.17531851630709155 + Q2)) + TMath::Power(Q2,4)*(33.792932040805404 + 4.41477762417959e-14*TMath::Sqrt(0.17531851630709155 + Q2)))/
    TMath::Power(0.6747729368514208 + TMath::Sqrt(0.17531851630709155 + Q2),16));
  }

  double JointFitError( double Q2 )
  {
    return TMath::Sqrt((3.61826373570992 + 1.3400135352562059e-31*TMath::Power(Q2,8) - 8.641444124406135*TMath::Sqrt(0.17531851630709155 + Q2) + TMath::Power(Q2,2)*(147.03341061261753 - 178.6341522216771*TMath::Sqrt(0.17531851630709155 + Q2)) + 
      TMath::Power(Q2,3)*(195.31198149602633 - 131.36710296471017*TMath::Sqrt(0.17531851630709155 + Q2)) + Q2*(39.80305477439668 - 70.41604478565155*TMath::Sqrt(0.17531851630709155 + Q2)) + 
      TMath::Power(Q2,6)*(7.012650408307185e-16 - 4.09551657052969e-30*TMath::Sqrt(0.17531851630709155 + Q2)) + TMath::Power(Q2,7)*(6.949261212536341e-29 + 3.2444678417633846e-30*TMath::Sqrt(0.17531851630709155 + Q2)) + 
      TMath::Power(Q2,5)*(-5.409029169306244e-14 + 4.941387756154378e-14*TMath::Sqrt(0.17531851630709155 + Q2)) + TMath::Power(Q2,4)*(45.5392601832924 + 1.6582035968773561e-13*TMath::Sqrt(0.17531851630709155 + Q2)))/
    TMath::Power(0.6747729368514208 + TMath::Sqrt(0.17531851630709155 + Q2),16));
  }



  double chiSq( double *x, double *par )
  {
    double a1 = par[0];
    double a2 = par[1];
    double a3 = par[2];
    double a4 = par[3];
    double lambda = par[4];
    return 370.336394128064 - 427.48994648731997*a1 + 126.64471581668879*TMath::Power(a1,2) - 19.94538217187994*a2 + 13.597528459175319*a1*a2 + 2.1369307329468405*TMath::Power(a2,2) - 21.18952976504671*a3 + 13.055563800428734*a1*a3 + 
   1.196677850815547*a2*a3 + 0.38385608376592445*TMath::Power(a3,2) + 2.464297698745259*a4 - 1.3443253314274675*a1*a4 + 0.16614113278932668*a2*a4 - 0.03600713886068577*a3*a4 + 0.01183509969671437*TMath::Power(a4,2) + 2.*lambda - 
   2.*lambda*TMath::Max(1.,0.24*TMath::Abs((166.86406879160182 - 109.28484420214343*a1 - 34.79379842176818*a2 - 20.247390066882243*a3 - 5.0850247763019425*a4)/
        (1.1918862056542987 - 0.1806060300153102*a1 + 0.07290143984451301*a2 - 0.0017670719063017247*a3 + 0.0065355373121289825*a4))) + 
   1.*lambda*TMath::Power(TMath::Max(1.,0.24*TMath::Abs((166.86406879160182 - 109.28484420214343*a1 - 34.79379842176818*a2 - 20.247390066882243*a3 - 5.0850247763019425*a4)/
         (1.1918862056542987 - 0.1806060300153102*a1 + 0.07290143984451301*a2 - 0.0017670719063017247*a3 + 0.0065355373121289825*a4))),2) - 
   2.*lambda*TMath::Max(1.,0.2*TMath::Abs((66.74562751664074 - 45.11393768085737*a1 - 15.917519368707271*a2 - 10.098956026752896*a3 - 3.634009910520777*a4)/
        (1.1918862056542987 - 0.1806060300153102*a1 + 0.07290143984451301*a2 - 0.0017670719063017247*a3 + 0.0065355373121289825*a4))) + 
   1.*lambda*TMath::Power(TMath::Max(1.,0.2*TMath::Abs((66.74562751664074 - 45.11393768085737*a1 - 15.917519368707271*a2 - 10.098956026752896*a3 - 3.634009910520777*a4)/
         (1.1918862056542987 - 0.1806060300153102*a1 + 0.07290143984451301*a2 - 0.0017670719063017247*a3 + 0.0065355373121289825*a4))),2) + 
   lambda*(-2.0000000000000004 + 4.*TMath::Max(1.,0.24*TMath::Abs((166.86406879160182 - 109.28484420214343*a1 - 34.79379842176818*a2 - 20.247390066882243*a3 - 5.0850247763019425*a4)/
           (1.1918862056542987 - 0.1806060300153102*a1 + 0.07290143984451301*a2 - 0.0017670719063017247*a3 + 0.0065355373121289825*a4))) - 
      2.0000000000000004*TMath::Power(TMath::Max(1.,0.24*TMath::Abs((166.86406879160182 - 109.28484420214343*a1 - 34.79379842176818*a2 - 20.247390066882243*a3 - 5.0850247763019425*a4)/
            (1.1918862056542987 - 0.1806060300153102*a1 + 0.07290143984451301*a2 - 0.0017670719063017247*a3 + 0.0065355373121289825*a4))),2))*
    TMath::Max(1.,0.28*TMath::Abs((143.02634467851584 - 91.67272360183722*a1 - 27.251827218658438*a2 - 15.212048628756207*a3 - 3.215735522544522*a4)/
        (1.1918862056542987 - 0.1806060300153102*a1 + 0.07290143984451301*a2 - 0.0017670719063017247*a3 + 0.0065355373121289825*a4)))*
    TMath::Power(1. - 1.*TMath::Max(1.,0.32*TMath::Abs((41.716017197900456 - 26.321211050535858*a1 - 7.448449605442044*a2 - 4.061847516720561*a3 - 0.7712561940754856*a4)/
           (1.1918862056542987 - 0.1806060300153102*a1 + 0.07290143984451301*a2 - 0.0017670719063017247*a3 + 0.0065355373121289825*a4))),2) + 
   lambda*(1. - 2.0000000000000004*TMath::Max(1.,0.24*TMath::Abs((166.86406879160182 - 109.28484420214343*a1 - 34.79379842176818*a2 - 20.247390066882243*a3 - 5.0850247763019425*a4)/
           (1.1918862056542987 - 0.1806060300153102*a1 + 0.07290143984451301*a2 - 0.0017670719063017247*a3 + 0.0065355373121289825*a4))) + 
      1.*TMath::Power(TMath::Max(1.,0.24*TMath::Abs((166.86406879160182 - 109.28484420214343*a1 - 34.79379842176818*a2 - 20.247390066882243*a3 - 5.0850247763019425*a4)/
            (1.1918862056542987 - 0.1806060300153102*a1 + 0.07290143984451301*a2 - 0.0017670719063017247*a3 + 0.0065355373121289825*a4))),2))*
    TMath::Power(TMath::Max(1.,0.28*TMath::Abs((143.02634467851584 - 91.67272360183722*a1 - 27.251827218658438*a2 - 15.212048628756207*a3 - 3.215735522544522*a4)/
         (1.1918862056542987 - 0.1806060300153102*a1 + 0.07290143984451301*a2 - 0.0017670719063017247*a3 + 0.0065355373121289825*a4))),2)*
    TMath::Power(1. - 1.*TMath::Max(1.,0.32*TMath::Abs((41.716017197900456 - 26.321211050535858*a1 - 7.448449605442044*a2 - 4.061847516720561*a3 - 0.7712561940754856*a4)/
           (1.1918862056542987 - 0.1806060300153102*a1 + 0.07290143984451301*a2 - 0.0017670719063017247*a3 + 0.0065355373121289825*a4))),2) - 
   2.*lambda*TMath::Max(1.,0.32*TMath::Abs((41.716017197900456 - 26.321211050535858*a1 - 7.448449605442044*a2 - 4.061847516720561*a3 - 0.7712561940754856*a4)/
        (1.1918862056542987 - 0.1806060300153102*a1 + 0.07290143984451301*a2 - 0.0017670719063017247*a3 + 0.0065355373121289825*a4))) + 
   4.*lambda*TMath::Max(1.,0.24*TMath::Abs((166.86406879160182 - 109.28484420214343*a1 - 34.79379842176818*a2 - 20.247390066882243*a3 - 5.0850247763019425*a4)/
        (1.1918862056542987 - 0.1806060300153102*a1 + 0.07290143984451301*a2 - 0.0017670719063017247*a3 + 0.0065355373121289825*a4)))*
    TMath::Max(1.,0.32*TMath::Abs((41.716017197900456 - 26.321211050535858*a1 - 7.448449605442044*a2 - 4.061847516720561*a3 - 0.7712561940754856*a4)/
        (1.1918862056542987 - 0.1806060300153102*a1 + 0.07290143984451301*a2 - 0.0017670719063017247*a3 + 0.0065355373121289825*a4))) - 
   2.*lambda*TMath::Power(TMath::Max(1.,0.24*TMath::Abs((166.86406879160182 - 109.28484420214343*a1 - 34.79379842176818*a2 - 20.247390066882243*a3 - 5.0850247763019425*a4)/
         (1.1918862056542987 - 0.1806060300153102*a1 + 0.07290143984451301*a2 - 0.0017670719063017247*a3 + 0.0065355373121289825*a4))),2)*
    TMath::Max(1.,0.32*TMath::Abs((41.716017197900456 - 26.321211050535858*a1 - 7.448449605442044*a2 - 4.061847516720561*a3 - 0.7712561940754856*a4)/
        (1.1918862056542987 - 0.1806060300153102*a1 + 0.07290143984451301*a2 - 0.0017670719063017247*a3 + 0.0065355373121289825*a4))) + 
   1.*lambda*TMath::Power(TMath::Max(1.,0.32*TMath::Abs((41.716017197900456 - 26.321211050535858*a1 - 7.448449605442044*a2 - 4.061847516720561*a3 - 0.7712561940754856*a4)/
         (1.1918862056542987 - 0.1806060300153102*a1 + 0.07290143984451301*a2 - 0.0017670719063017247*a3 + 0.0065355373121289825*a4))),2) - 
   2.*lambda*TMath::Max(1.,0.24*TMath::Abs((166.86406879160182 - 109.28484420214343*a1 - 34.79379842176818*a2 - 20.247390066882243*a3 - 5.0850247763019425*a4)/
        (1.1918862056542987 - 0.1806060300153102*a1 + 0.07290143984451301*a2 - 0.0017670719063017247*a3 + 0.0065355373121289825*a4)))*
    TMath::Power(TMath::Max(1.,0.32*TMath::Abs((41.716017197900456 - 26.321211050535858*a1 - 7.448449605442044*a2 - 4.061847516720561*a3 - 0.7712561940754856*a4)/
         (1.1918862056542987 - 0.1806060300153102*a1 + 0.07290143984451301*a2 - 0.0017670719063017247*a3 + 0.0065355373121289825*a4))),2) + 
   1.*lambda*TMath::Power(TMath::Max(1.,0.24*TMath::Abs((166.86406879160182 - 109.28484420214343*a1 - 34.79379842176818*a2 - 20.247390066882243*a3 - 5.0850247763019425*a4)/
         (1.1918862056542987 - 0.1806060300153102*a1 + 0.07290143984451301*a2 - 0.0017670719063017247*a3 + 0.0065355373121289825*a4))),2)*
    TMath::Power(TMath::Max(1.,0.32*TMath::Abs((41.716017197900456 - 26.321211050535858*a1 - 7.448449605442044*a2 - 4.061847516720561*a3 - 0.7712561940754856*a4)/
         (1.1918862056542987 - 0.1806060300153102*a1 + 0.07290143984451301*a2 - 0.0017670719063017247*a3 + 0.0065355373121289825*a4))),2);


  }

}





#endif
